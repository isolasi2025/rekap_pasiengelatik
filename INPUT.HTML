<!DOCTYPE html>

<html lang="id">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>REKAPITULASI PASIEN RUANG GELATIK</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&amp;display=swap" rel="stylesheet"/>
<style>
    body {
      font-family: 'Inter', sans-serif;
      background: #ffffff;
      margin: 0;
      padding: 2rem;
      color: #333333;
    }

    h2 {
      text-align: center;
      color: #333333;
      margin-bottom: 2rem;
      font-weight: 600;
    }

    form {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      background: #ffffff;
      padding: 2rem;
      border-radius: 12px;
      max-width: 1200px;
      margin: auto;
    }

    form > div, .full {
      background: transparent;
      padding: 0;
      border: none;
      box-shadow: none;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #333333;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      background: #ffffff;
      border: 1px solid #cccccc;
      border-radius: 8px;
      font-size: 14px;
      color: #333333;
      box-sizing: border-box;
    }

    input[readonly] {
      background-color: #f0f0f0;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .full {
      grid-column: span 3;
    }

    button {
      grid-column: span 3;
      padding: 12px;
      font-size: 16px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s ease;
    }

    button:hover {
      background: #2563eb;
    }

    .dpjp-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      border: 1px solid #cccccc;
      border-radius: 8px;
      padding: 8px;
      background: #ffffff;
    }

    .dpjp-tag {
      background: #ffffff;
      color: #333333;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid #3b82f6;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      margin: 4px;
    }

    .dpjp-tag button {
      background: none;
      border: none;
      color: #3b82f6;
      font-size: 16px;
      margin-left: 6px;
      cursor: pointer;
      line-height: 1;
    }

    .dpjp-wrapper input {
      background: transparent;
      border: none;
      color: #333333;
      flex: 1;
      font-size: 14px;
      min-width: 250px;
      outline: none;
    }

    .dpjp-suggestions {
      position: absolute;
      background: #ffffff;
      border: 1px solid #cccccc;
      list-style: none;
      margin: 0;
      padding: 0;
      z-index: 999;
      width: calc(100% - 32px);
      max-height: 200px;
      overflow-y: auto;
      color: #333333;
    }

    .dpjp-suggestions:empty {
      display: none;
      border: none;
    }

    .dpjp-suggestions li {
      padding: 10px;
      cursor: pointer;
    }

    .dpjp-suggestions li:hover {
      background-color: #f3f4f6;
    }

    @media (max-width: 1024px) {
      form { grid-template-columns: repeat(2, 1fr); }
      .full { grid-column: span 2; }
    }

    @media (max-width: 600px) {
      form { grid-template-columns: 1fr; }
      .full { grid-column: span 1; }
    }
  </style>
</head>
<body>
<h2>REKAPITULASI PASIEN RUANG GELATIK</h2>
<form id="rekapForm">
<div><label>No. RM</label><input name="no_rm" required=""/></div>
<div><label>Nama Pasien</label><input name="nama_pasien" required=""/></div>
<div><label>Tanggal Lahir</label><input id="tgl_lahir" name="tgl_lahir" required="" type="date"/></div>
<div><label>Umur</label><input id="umur" name="umur" readonly="" type="number"/></div>
<div><label>Alamat</label><textarea name="alamat" required=""></textarea></div>
<div><label>Jenis Kelamin</label>
<select name="jenis_kelamin" required="">
<option value="">-- Pilih --</option>
<option>Laki-laki</option>
<option>Perempuan</option>
</select>
</div>
<div><label>Tanggal MRS</label><input id="tgl_mrs" name="tgl_mrs" required="" type="date"/></div>
<div><label>Tanggal KRS</label><input id="tgl_krs" name="tgl_krs" required="" type="date"/></div>
<div><label>Lama Perawatan</label><input id="lama_perawatan" name="lama_perawatan" readonly="" type="number"/></div>
<div><label>Diagnosa</label><input name="diagnosa" required=""/></div>
<div><label>Penjamin</label>
<select name="penjamin" required="">
<option value="">-- Pilih --</option>
<option>BPJS Kelas 1</option>
<option>BPJS Kelas 2</option>
<option>BPJS Kelas 3/PBI</option>
<option>PBID</option>
<option>Umum</option>
<option>Global Fund</option>
<option>Jasa Raharja</option>
</select>
</div>
<div><label>Keterangan</label>
<select name="keterangan">
<option value="">-- Pilih --</option>
<option>Membaik</option>
<option>Meninggal</option>
<option>APS</option>
<option>Rujuk</option>
<option>Pindah Ruang</option>
</select>
</div>
<div class="full">
<label>DPJP</label>
<div class="dpjp-wrapper" id="dpjpWrapper">
<div id="dpjpTags"></div>
<input id="dpjpInput" placeholder="Ketik nama dokter..." type="text"/>
<input id="dpjpHidden" name="dpjp" type="hidden"/>
</div>
<ul class="dpjp-suggestions" id="dpjpSuggestions"></ul>
</div>
<button type="submit">Kirim Data</button>
</form><div class="full">
<input id="namaSheetBaru" placeholder="Nama Sheet Baru" type="text"/>
<button onclick="addSheet()" type="button">Tambah Sheet Baru ke Google Sheets</button>
</div>
<script>
  const umurInput = document.getElementById('umur');
  const tglLahirInput = document.getElementById('tgl_lahir');
  const tglMRSInput = document.getElementById('tgl_mrs');
  const tglKRSInput = document.getElementById('tgl_krs');
  const lamaInput = document.getElementById('lama_perawatan');
  const form = document.getElementById('rekapForm');
  const dpjpInput = document.getElementById('dpjpInput');
  const dpjpSuggestions = document.getElementById('dpjpSuggestions');
  const dpjpTags = document.getElementById('dpjpTags');
  const dpjpHidden = document.getElementById('dpjpHidden');
  const scriptURL = 'https://script.google.com/macros/s/AKfycbySocqZA4R9k28Wo3FiXEIcXtyL9LZbOn3WwH-UjZqhFJBz8HktOu9LKw--Zp3MbiyjYA/exec';

  const dpjpList = [
    "dr. CAESAR ENSANG TIMUDA, Sp.P", "dr. AGUNG SANDI RAMADAN, Sp.PD", "dr. FEBRIAN DARU SETIAWAN, Sp.PD",
    "dr. HARNOWO WILUJENG, Sp.PD-FINASIM", "dr. MOHAMMAD AFIES SJUGHIARTO, Sp.Jp, MMRS",
    "dr. LAURENTIA DIVINA RESPATI, Sp.S", "dr. ANITA SURYA SANTOSO, Sp.JP", "dr. RIDZA ASRUL PRAMUDYA, Sp.N",
    "dr. NORMAN HADI, Sp.B.", "dr. ANGGAYASTI, Sp.A., M.Kes", "dr. CHRISTOPHER ANTONY SIMANDJUNTAK, Sp.OT",
    "dr. RIZQI WAHYU HARIYONO, Sp.M", "dr. ARI SARDITO, Sp.B", "dr. FARAH AYU NISWANA, Sp.THT-KL",
    "dr. RAHMAD KRISMANTORO, Sp.U", "dr. BAYU PRABOWO, Sp. A.", "dr. EKO WAHYUDI, Sp. A",
    "dr. EMY KUSUMANINGSIH, Sp. DV", "dr. FERRIE BUDIANTO, Sp. An", "dr. WINDY ARI WIJAYA, Sp.An",
    "dr. HEDINA SUWONDO, Sp.KJ"
  ];

  let selectedDPJP = [];

  tglLahirInput.addEventListener('change', () => {
    const birth = new Date(tglLahirInput.value);
    const today = new Date();
    let age = today.getFullYear() - birth.getFullYear();
    const m = today.getMonth() - birth.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
    umurInput.value = age >= 0 ? age : '';
  });

  function hitungLama() {
    const mrs = new Date(tglMRSInput.value);
    const krs = new Date(tglKRSInput.value);
    if (!isNaN(mrs) && !isNaN(krs)) {
      const diff = (krs - mrs) / (1000 * 60 * 60 * 24);
      lamaInput.value = diff >= 0 ? diff : '';
    }
  }

  tglMRSInput.addEventListener('change', hitungLama);
  tglKRSInput.addEventListener('change', hitungLama);

  dpjpInput.addEventListener("input", () => {
    const val = dpjpInput.value.toLowerCase();
    dpjpSuggestions.innerHTML = "";
    const matches = dpjpList.filter(name => name.toLowerCase().includes(val) && !selectedDPJP.includes(name));
    matches.forEach(name => {
      const li = document.createElement("li");
      li.textContent = name;
      li.onclick = () => {
        selectedDPJP.push(name);
        updateDPJP();
        dpjpInput.value = "";
        dpjpSuggestions.innerHTML = "";
      };
      dpjpSuggestions.appendChild(li);
    });
  });

  function updateDPJP() {
    dpjpTags.innerHTML = "";
    selectedDPJP.forEach(name => {
      const tag = document.createElement("span");
      tag.className = "dpjp-tag";
      tag.innerHTML = `${name}<button>&times;</button>`;
      tag.querySelector("button").onclick = () => {
        selectedDPJP = selectedDPJP.filter(d => d !== name);
        updateDPJP();
      };
      dpjpTags.appendChild(tag);
    });
    dpjpHidden.value = selectedDPJP.join(" + ");
  }

  document.addEventListener("click", (e) => {
    if (!dpjpInput.contains(e.target) && !dpjpSuggestions.contains(e.target)) {
      dpjpSuggestions.innerHTML = "";
    }
  });

  form.addEventListener('submit', e => {
    e.preventDefault();
    fetch(scriptURL, { method: 'POST', body: new FormData(form) })
      .then(() => {
        alert('✅ Data berhasil dikirim!');
        form.reset();
        selectedDPJP = [];
        dpjpTags.innerHTML = '';
        dpjpHidden.value = '';
        umurInput.value = '';
        lamaInput.value = '';
      })
      .catch(() => {
        alert('❌ Gagal mengirim data.');
      });
  });
</script>
<script src="https://apis.google.com/js/api.js"></script>
<script>
  const CLIENT_ID = '102861957108-gk20h4p29q6s2ep12mlik5d01geaj90k.apps.googleusercontent.com';
  const API_KEY = 'AIzaSyBLWA4VpHOTbO_vwANMgZMbiuOq7yLmzNs';
  const SPREADSHEET_ID = '1MbS_vO7Q2kPbN4z4eoJcTy7jfgAQFrnnEG29TB0UvpQ';
  const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

  function gapiLoaded() {
    gapi.load('client:auth2', initGapiClient);
  }

  async function initGapiClient() {
    await gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
      scope: SCOPES
    });
    if (!gapi.auth2.getAuthInstance().isSignedIn.get()) {
      await gapi.auth2.getAuthInstance().signIn();
    }
  }

  async function addSheet() {
    // Log email pengguna yang sedang login
    const user = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile();
    console.log("Login sebagai:", user.getEmail());

    const sheetName = document.getElementById('namaSheetBaru').value.trim();
    if (!sheetName) {
      alert("❗ Masukkan nama sheet terlebih dahulu.");
      return;
    }

    const request = {
      spreadsheetId: SPREADSHEET_ID,
      resource: {
        requests: [{
          addSheet: {
            properties: { title: sheetName }
          }
        }]
      }
    };

    try {
      await gapi.client.sheets.spreadsheets.batchUpdate(request);
      alert(`✅ Sheet "${sheetName}" berhasil ditambahkan.`);
    } catch (err) {
    console.error("❌ Gagal menambahkan sheet:", err);
    alert("❌ Gagal menambahkan sheet: " + (err.result?.error?.message || err.message));
      console.error(err);
      alert("❌ Gagal menambahkan sheet.");
    }
  }

  window.onload = gapiLoaded;
</script>
</body>
</html>
